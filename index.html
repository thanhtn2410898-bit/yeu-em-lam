<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.3">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="vi"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta charset="UTF-8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta name="viewport" content="width=device-width,initial-scale=1" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;title&gt;Yêu Em&lt;/title&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>html, body { margin:0; height:100%; background:#0b1022; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>#app { position:fixed; inset:0; overflow:hidden; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>canvas { display:block; width:100%; height:100%; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* UI panel */</p>
<p class="p1"><span class="Apple-converted-space">    </span>.panel {</p>
<p class="p1"><span class="Apple-converted-space">      </span>position:fixed; top:14px; left:14px; width: 360px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>background: rgba(10,12,25,0.55);</p>
<p class="p1"><span class="Apple-converted-space">      </span>border: 1px solid rgba(255,255,255,0.10);</p>
<p class="p1"><span class="Apple-converted-space">      </span>border-radius: 14px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>padding: 12px 12px 10px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>color: rgba(255,255,255,0.92);</p>
<p class="p1"><span class="Apple-converted-space">      </span>backdrop-filter: blur(10px);</p>
<p class="p1"><span class="Apple-converted-space">      </span>z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.panel h2 { margin:6px 0 8px; font-size: 15px; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.hint { font-size: 12.5px; line-height: 1.5; color: rgba(255,255,255,0.75); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.row { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>button {</p>
<p class="p1"><span class="Apple-converted-space">      </span>background:#1f2a5a; color:#fff; border:1px solid rgba(255,255,255,0.15);</p>
<p class="p1"><span class="Apple-converted-space">      </span>padding:10px 12px; border-radius:10px; cursor:pointer;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>button:disabled { opacity:0.5; cursor:not-allowed; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color: rgba(255,255,255,0.85); margin-top:10px; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.toggle { display:flex; align-items:center; gap:8px; user-select:none; margin-top:10px; font-size:12.5px; color: rgba(255,255,255,0.8); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>input[type="checkbox"] { transform: scale(1.1); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* Webcam debug */</p>
<p class="p1"><span class="Apple-converted-space">    </span>#video {</p>
<p class="p1"><span class="Apple-converted-space">      </span>width: 100%;</p>
<p class="p1"><span class="Apple-converted-space">      </span>margin-top: 10px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>border-radius: 12px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>background:#000;</p>
<p class="p1"><span class="Apple-converted-space">      </span>display:none;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* 3-photo overlay (double blink) */</p>
<p class="p1"><span class="Apple-converted-space">    </span>#photoOverlay {</p>
<p class="p1"><span class="Apple-converted-space">      </span>position:fixed;</p>
<p class="p1"><span class="Apple-converted-space">      </span>right: 18px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>top: 50%;</p>
<p class="p1"><span class="Apple-converted-space">      </span>transform: translateY(-50%);</p>
<p class="p1"><span class="Apple-converted-space">      </span>width: min(320px, 30vw);</p>
<p class="p1"><span class="Apple-converted-space">      </span>z-index: 12;</p>
<p class="p1"><span class="Apple-converted-space">      </span>opacity: 0;</p>
<p class="p1"><span class="Apple-converted-space">      </span>pointer-events: none;</p>
<p class="p1"><span class="Apple-converted-space">      </span>transition: opacity 220ms ease;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>#photoOverlay.on { opacity: 1; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.photoPanel {</p>
<p class="p1"><span class="Apple-converted-space">      </span>background: rgba(255,240,200,0.12);</p>
<p class="p1"><span class="Apple-converted-space">      </span>border: 1px solid rgba(255,255,255,0.18);</p>
<p class="p1"><span class="Apple-converted-space">      </span>border-radius: 18px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>padding: 12px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>backdrop-filter: blur(10px);</p>
<p class="p1"><span class="Apple-converted-space">      </span>box-shadow: 0 0 40px rgba(255,240,200,0.12);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.photoStack { display:grid; gap:12px; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.photoStack img {</p>
<p class="p1"><span class="Apple-converted-space">      </span>width:100%;</p>
<p class="p1"><span class="Apple-converted-space">      </span>aspect-ratio: 4/3;</p>
<p class="p1"><span class="Apple-converted-space">      </span>object-fit: cover;</p>
<p class="p1"><span class="Apple-converted-space">      </span>border-radius: 14px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>border: 1px solid rgba(255,255,255,0.18);</p>
<p class="p1"><span class="Apple-converted-space">      </span>box-shadow: 0 0 24px rgba(255,255,255,0.08);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;!-- MediaPipe FaceMesh (browser) --&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"&gt;&lt;/script&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script type="importmap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>{</p>
<p class="p1"><span class="Apple-converted-space">      </span>"imports": {</p>
<p class="p1"><span class="Apple-converted-space">        </span>"three": "https://unpkg.com/three@0.160.0/build/three.module.js",</p>
<p class="p1"><span class="Apple-converted-space">        </span>"three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="app"&gt;&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h2&gt;Yêu Em&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="hint"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>- Blink: boost đèn + orb “pulse” + shake&lt;br/&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>- Nhìn trái: pan về cây thông&lt;br/&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>- Nhìn phải: zoom vào cửa (thư)&lt;br/&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>- Double blink: hiện 3 ảnh trong 4 giây&lt;br/&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>Lưu ý: camera chỉ chạy trên HTTPS hoặc localhost.</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="startBtn"&gt;Bật camera&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="stopBtn" disabled&gt;Tắt camera&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;label class="toggle"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;input id="showVideo" type="checkbox" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>Hiện webcam (debug)</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;video id="video" autoplay playsinline muted&gt;&lt;/video&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="mono" id="stat"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="photoOverlay"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="photoPanel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="photoStack"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;img src="coay_1.jpg" alt="coay_1" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;img src="coay_2.jpg" alt="coay_2" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;img src="coay_3.jpg" alt="coay_3" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script type="module"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>import * as THREE from "three";</p>
<p class="p1"><span class="Apple-converted-space">    </span>import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";</p>
<p class="p1"><span class="Apple-converted-space">    </span>import { RenderPass } from "three/addons/postprocessing/RenderPass.js";</p>
<p class="p1"><span class="Apple-converted-space">    </span>import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* =========================================================</p>
<p class="p1"><span class="Apple-converted-space">       </span>CONFIG</p>
<p class="p1"><span class="Apple-converted-space">    </span>========================================================= */</p>
<p class="p1"><span class="Apple-converted-space">    </span>const EAR_BLINK_THRESHOLD = 0.18;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const BLINK_MIN_FRAMES = 2;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const DOUBLE_BLINK_WINDOW = 550; // ms</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const GAZE_DEADZONE = 0.04;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const GAZE_LEFT_TH<span class="Apple-converted-space">  </span>= -0.08;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const GAZE_RIGHT_TH = 0.08;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const GAZE_SMOOTH <span class="Apple-converted-space">  </span>= 0.85;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const PHOTO_SHOW_MS = 4000;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// FaceMesh indices</p>
<p class="p1"><span class="Apple-converted-space">    </span>const LEFT_EYE_IDX<span class="Apple-converted-space">  </span>= [33, 160, 158, 133, 153, 144];</p>
<p class="p1"><span class="Apple-converted-space">    </span>const RIGHT_EYE_IDX = [362, 385, 387, 263, 373, 380];</p>
<p class="p1"><span class="Apple-converted-space">    </span>const RIGHT_IRIS<span class="Apple-converted-space">    </span>= [469, 470, 471, 472];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const clamp = (x,a,b)=&gt;Math.max(a, Math.min(b,x));</p>
<p class="p1"><span class="Apple-converted-space">    </span>const smoothstep = (p)=&gt;{ p = clamp(p,0,1); return p*p*(3-2*p); };</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>function getPt(lm, i){ return {x: lm[i].x, y: lm[i].y}; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function eyeAspectRatio(lm, idxs){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p1 = getPt(lm, idxs[0]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p2 = getPt(lm, idxs[1]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p3 = getPt(lm, idxs[2]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p4 = getPt(lm, idxs[3]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p5 = getPt(lm, idxs[4]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p6 = getPt(lm, idxs[5]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const a = dist(p2,p6);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const b = dist(p3,p5);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const c = dist(p1,p4);</p>
<p class="p1"><span class="Apple-converted-space">      </span>return (a+b)/(2*c + 1e-6);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function meanPoint(lm, idxs){</p>
<p class="p1"><span class="Apple-converted-space">      </span>let x=0,y=0;</p>
<p class="p1"><span class="Apple-converted-space">      </span>for(const i of idxs){ x += lm[i].x; y += lm[i].y; }</p>
<p class="p1"><span class="Apple-converted-space">      </span>return {x: x/idxs.length, y: y/idxs.length};</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function estimateGazeX(lm){</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Iris center relative to right eye corners, normalized =&gt; [-0.25..0.25]</p>
<p class="p1"><span class="Apple-converted-space">      </span>const eye = RIGHT_EYE_IDX.map(i=&gt;getPt(lm,i));</p>
<p class="p1"><span class="Apple-converted-space">      </span>const irisC = meanPoint(lm, RIGHT_IRIS);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const eyeLeft = eye[0];</p>
<p class="p1"><span class="Apple-converted-space">      </span>const eyeRight = eye[3];</p>
<p class="p1"><span class="Apple-converted-space">      </span>const eyeW = dist(eyeLeft, eyeRight) + 1e-6;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const xNorm = (irisC.x - eyeLeft.x) / eyeW;</p>
<p class="p1"><span class="Apple-converted-space">      </span>return clamp(xNorm - 0.5, -0.25, 0.25);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* =========================================================</p>
<p class="p1"><span class="Apple-converted-space">       </span>THREE.JS SCENE</p>
<p class="p1"><span class="Apple-converted-space">    </span>========================================================= */</p>
<p class="p1"><span class="Apple-converted-space">    </span>const app = document.getElementById("app");</p>
<p class="p1"><span class="Apple-converted-space">    </span>const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });</p>
<p class="p1"><span class="Apple-converted-space">    </span>renderer.setPixelRatio(Math.min(devicePixelRatio, 2));</p>
<p class="p1"><span class="Apple-converted-space">    </span>renderer.setSize(window.innerWidth, window.innerHeight);</p>
<p class="p1"><span class="Apple-converted-space">    </span>renderer.setClearColor(0x0b1022, 1);</p>
<p class="p1"><span class="Apple-converted-space">    </span>app.appendChild(renderer.domElement);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const scene = new THREE.Scene();</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.fog = new THREE.Fog(0x0b1022, 8, 32);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 200);</p>
<p class="p1"><span class="Apple-converted-space">    </span>camera.position.set(0, 3.6, 12);</p>
<p class="p1"><span class="Apple-converted-space">    </span>camera.lookAt(0, 2.0, 0);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Composer + Bloom</p>
<p class="p1"><span class="Apple-converted-space">    </span>const composer = new EffectComposer(renderer);</p>
<p class="p1"><span class="Apple-converted-space">    </span>composer.addPass(new RenderPass(scene, camera));</p>
<p class="p1"><span class="Apple-converted-space">    </span>const bloom = new UnrealBloomPass(</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.Vector2(window.innerWidth, window.innerHeight),</p>
<p class="p1"><span class="Apple-converted-space">      </span>0.9,<span class="Apple-converted-space">  </span>// strength</p>
<p class="p1"><span class="Apple-converted-space">      </span>0.35, // radius</p>
<p class="p1"><span class="Apple-converted-space">      </span>0.25<span class="Apple-converted-space">  </span>// threshold</p>
<p class="p1"><span class="Apple-converted-space">    </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>composer.addPass(bloom);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Lights</p>
<p class="p1"><span class="Apple-converted-space">    </span>const ambient = new THREE.AmbientLight(0xffffff, 0.25);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(ambient);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const moonLight = new THREE.DirectionalLight(0xbfd8ff, 0.55);</p>
<p class="p1"><span class="Apple-converted-space">    </span>moonLight.position.set(-6, 10, 6);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(moonLight);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Ground</p>
<p class="p1"><span class="Apple-converted-space">    </span>const groundGeo = new THREE.PlaneGeometry(70, 50);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const groundMat = new THREE.MeshStandardMaterial({ color: 0xdee2ea, roughness: 0.9, metalness: 0.0 });</p>
<p class="p1"><span class="Apple-converted-space">    </span>const ground = new THREE.Mesh(groundGeo, groundMat);</p>
<p class="p1"><span class="Apple-converted-space">    </span>ground.rotation.x = -Math.PI/2;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ground.position.y = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(ground);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// House (simple stylized)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const house = new THREE.Group();</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(house);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const base = new THREE.Mesh(</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.BoxGeometry(6, 4.2, 5),</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.MeshStandardMaterial({ color: 0x78462e, roughness: 0.95 })</p>
<p class="p1"><span class="Apple-converted-space">    </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>base.position.set(0, 2.1, 0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>house.add(base);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const roof = new THREE.Mesh(</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.ConeGeometry(4.8, 2.2, 4),</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.MeshStandardMaterial({ color: 0x5b2a22, roughness: 0.95 })</p>
<p class="p1"><span class="Apple-converted-space">    </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>roof.position.set(0, 5.1, 0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>roof.rotation.y = Math.PI/4;</p>
<p class="p1"><span class="Apple-converted-space">    </span>house.add(roof);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const chimney = new THREE.Mesh(</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.BoxGeometry(1.1, 2.8, 1.1),</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.MeshStandardMaterial({ color: 0x3d1c18, roughness: 0.95 })</p>
<p class="p1"><span class="Apple-converted-space">    </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>chimney.position.set(2.1, 6.0, -0.8);</p>
<p class="p1"><span class="Apple-converted-space">    </span>house.add(chimney);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Door anchor (for camera zoom)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const doorAnchor = new THREE.Object3D();</p>
<p class="p1"><span class="Apple-converted-space">    </span>doorAnchor.position.set(0, 1.6, 2.45);</p>
<p class="p1"><span class="Apple-converted-space">    </span>house.add(doorAnchor);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Tree (stylized)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const tree = new THREE.Group();</p>
<p class="p1"><span class="Apple-converted-space">    </span>tree.position.set(-6, 0, 2);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(tree);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const trunk = new THREE.Mesh(</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.CylinderGeometry(0.25, 0.3, 1.2, 12),</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.MeshStandardMaterial({ color: 0x5a3c23, roughness: 0.95 })</p>
<p class="p1"><span class="Apple-converted-space">    </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>trunk.position.set(0, 0.6, 0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>tree.add(trunk);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const foliage = new THREE.Mesh(</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.ConeGeometry(1.9, 3.8, 20),</p>
<p class="p1"><span class="Apple-converted-space">      </span>new THREE.MeshStandardMaterial({ color: 0x2a8b4a, roughness: 0.95 })</p>
<p class="p1"><span class="Apple-converted-space">    </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>foliage.position.set(0, 2.8, 0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>tree.add(foliage);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const treeAnchor = new THREE.Object3D();</p>
<p class="p1"><span class="Apple-converted-space">    </span>treeAnchor.position.set(-6, 2.2, 2);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(treeAnchor);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Roof string lights (emissive + bloom)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const bulbs = new THREE.Group();</p>
<p class="p1"><span class="Apple-converted-space">    </span>house.add(bulbs);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>const bulbGeo = new THREE.SphereGeometry(0.08, 12, 12);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const bulbMats = Array.from({length: 14}, (_,i)=&gt; new THREE.MeshStandardMaterial({</p>
<p class="p1"><span class="Apple-converted-space">      </span>color: 0xffffff,</p>
<p class="p1"><span class="Apple-converted-space">      </span>emissive: new THREE.Color().setHSL((i*0.11)%1, 0.8, 0.55),</p>
<p class="p1"><span class="Apple-converted-space">      </span>emissiveIntensity: 1.4,</p>
<p class="p1"><span class="Apple-converted-space">      </span>roughness: 0.3,</p>
<p class="p1"><span class="Apple-converted-space">      </span>metalness: 0.0</p>
<p class="p1"><span class="Apple-converted-space">    </span>}));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>for(let i=0;i&lt;14;i++){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const m = bulbMats[i];</p>
<p class="p1"><span class="Apple-converted-space">      </span>const b = new THREE.Mesh(bulbGeo, m);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const x = -2.6 + i*0.4;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const y = 4.35 + Math.sin(i*0.45)*0.08;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const z = 2.4 - Math.abs(Math.sin(i*0.25))*0.55;</p>
<p class="p1"><span class="Apple-converted-space">      </span>b.position.set(x, y, z);</p>
<p class="p1"><span class="Apple-converted-space">      </span>bulbs.add(b);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Smoke (billboard sprites)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const smokeGroup = new THREE.Group();</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(smokeGroup);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function spawnSmoke(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const sprMat = new THREE.SpriteMaterial({</p>
<p class="p1"><span class="Apple-converted-space">        </span>color: 0xe6e9ef,</p>
<p class="p1"><span class="Apple-converted-space">        </span>transparent: true,</p>
<p class="p1"><span class="Apple-converted-space">        </span>opacity: 0.18</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>const s = new THREE.Sprite(sprMat);</p>
<p class="p1"><span class="Apple-converted-space">      </span>s.position.copy(chimney.getWorldPosition(new THREE.Vector3())).add(new THREE.Vector3(</p>
<p class="p1"><span class="Apple-converted-space">        </span>(Math.random()*2-1)*0.08, 0.4, (Math.random()*2-1)*0.08</p>
<p class="p1"><span class="Apple-converted-space">      </span>));</p>
<p class="p1"><span class="Apple-converted-space">      </span>s.scale.setScalar(0.6 + Math.random()*0.25);</p>
<p class="p1"><span class="Apple-converted-space">      </span>s.userData = {</p>
<p class="p1"><span class="Apple-converted-space">        </span>vx: (Math.random()*2-1)*0.14,</p>
<p class="p1"><span class="Apple-converted-space">        </span>vy: 0.55 + Math.random()*0.25,</p>
<p class="p1"><span class="Apple-converted-space">        </span>vz: (Math.random()*2-1)*0.14,</p>
<p class="p1"><span class="Apple-converted-space">        </span>life: 1.8 + Math.random()*0.7,</p>
<p class="p1"><span class="Apple-converted-space">        </span>t: 0</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p1"><span class="Apple-converted-space">      </span>smokeGroup.add(s);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Snow particle system (Points)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const snowCount = 1800;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const snowGeo = new THREE.BufferGeometry();</p>
<p class="p1"><span class="Apple-converted-space">    </span>const snowPos = new Float32Array(snowCount * 3);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const snowVel = new Float32Array(snowCount * 3);</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(let i=0;i&lt;snowCount;i++){</p>
<p class="p1"><span class="Apple-converted-space">      </span>snowPos[i*3+0] = (Math.random()*2-1)*22;</p>
<p class="p1"><span class="Apple-converted-space">      </span>snowPos[i*3+1] = Math.random()*14 + 1;</p>
<p class="p1"><span class="Apple-converted-space">      </span>snowPos[i*3+2] = (Math.random()*2-1)*18;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>snowVel[i*3+0] = (Math.random()*2-1)*0.10;</p>
<p class="p1"><span class="Apple-converted-space">      </span>snowVel[i*3+1] = -(0.8 + Math.random()*1.8);</p>
<p class="p1"><span class="Apple-converted-space">      </span>snowVel[i*3+2] = (Math.random()*2-1)*0.10;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>snowGeo.setAttribute("position", new THREE.BufferAttribute(snowPos, 3));</p>
<p class="p1"><span class="Apple-converted-space">    </span>const snowMat = new THREE.PointsMaterial({</p>
<p class="p1"><span class="Apple-converted-space">      </span>color: 0xfafaff,</p>
<p class="p1"><span class="Apple-converted-space">      </span>size: 0.03,</p>
<p class="p1"><span class="Apple-converted-space">      </span>transparent: true,</p>
<p class="p1"><span class="Apple-converted-space">      </span>opacity: 0.9</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>const snowPoints = new THREE.Points(snowGeo, snowMat);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(snowPoints);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Guide orb (emissive sphere + bloom)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const orbGeo = new THREE.SphereGeometry(0.22, 32, 32);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const orbMat = new THREE.MeshStandardMaterial({</p>
<p class="p1"><span class="Apple-converted-space">      </span>color: 0xffffff,</p>
<p class="p1"><span class="Apple-converted-space">      </span>emissive: 0xffe5b8,</p>
<p class="p1"><span class="Apple-converted-space">      </span>emissiveIntensity: 2.8,</p>
<p class="p1"><span class="Apple-converted-space">      </span>roughness: 0.2,</p>
<p class="p1"><span class="Apple-converted-space">      </span>metalness: 0.0</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>const orb = new THREE.Mesh(orbGeo, orbMat);</p>
<p class="p1"><span class="Apple-converted-space">    </span>orb.position.set(3.0, 4.8, 3.0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(orb);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Orb trail (simple line points)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const trailMax = 55;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const trailPts = [];</p>
<p class="p1"><span class="Apple-converted-space">    </span>const trailGeo = new THREE.BufferGeometry();</p>
<p class="p1"><span class="Apple-converted-space">    </span>const trailPos = new Float32Array(trailMax * 3);</p>
<p class="p1"><span class="Apple-converted-space">    </span>trailGeo.setAttribute("position", new THREE.BufferAttribute(trailPos, 3));</p>
<p class="p1"><span class="Apple-converted-space">    </span>const trailMat = new THREE.LineBasicMaterial({ color: 0xffe5b8, transparent: true, opacity: 0.35 });</p>
<p class="p1"><span class="Apple-converted-space">    </span>const trail = new THREE.Line(trailGeo, trailMat);</p>
<p class="p1"><span class="Apple-converted-space">    </span>scene.add(trail);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function pushTrail(v){</p>
<p class="p1"><span class="Apple-converted-space">      </span>trailPts.push(v.clone());</p>
<p class="p1"><span class="Apple-converted-space">      </span>while(trailPts.length &gt; trailMax) trailPts.shift();</p>
<p class="p1"><span class="Apple-converted-space">      </span>for(let i=0;i&lt;trailMax;i++){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const p = trailPts[Math.max(0, trailPts.length-trailMax+i)] || trailPts[0] || v;</p>
<p class="p1"><span class="Apple-converted-space">        </span>trailPos[i*3+0] = p.x;</p>
<p class="p1"><span class="Apple-converted-space">        </span>trailPos[i*3+1] = p.y;</p>
<p class="p1"><span class="Apple-converted-space">        </span>trailPos[i*3+2] = p.z;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>trailGeo.attributes.position.needsUpdate = true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Camera targets</p>
<p class="p1"><span class="Apple-converted-space">    </span>const camBasePos = new THREE.Vector3(0, 3.6, 12);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const camBaseLook = new THREE.Vector3(0, 2.2, 0);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function getDoorCam(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p = doorAnchor.getWorldPosition(new THREE.Vector3());</p>
<p class="p1"><span class="Apple-converted-space">      </span>const camP = p.clone().add(new THREE.Vector3(0, 1.4, 2.6)); // closer</p>
<p class="p1"><span class="Apple-converted-space">      </span>const look = p.clone().add(new THREE.Vector3(0, 0.4, 0));</p>
<p class="p1"><span class="Apple-converted-space">      </span>return { camP, look };</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function getTreeCam(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const p = treeAnchor.getWorldPosition(new THREE.Vector3());</p>
<p class="p1"><span class="Apple-converted-space">      </span>const camP = p.clone().add(new THREE.Vector3(0.5, 1.6, 4.3));</p>
<p class="p1"><span class="Apple-converted-space">      </span>const look = p.clone().add(new THREE.Vector3(0, 0.4, 0));</p>
<p class="p1"><span class="Apple-converted-space">      </span>return { camP, look };</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// State driven by eye</p>
<p class="p1"><span class="Apple-converted-space">    </span>let cameraMode = "BASE"; // BASE | DOOR | TREE</p>
<p class="p1"><span class="Apple-converted-space">    </span>let cameraModeUntil = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let lightsBoostUntil = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let shakeUntil = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let orbPulseUntil = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let photoShowUntil = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Smooth gaze</p>
<p class="p1"><span class="Apple-converted-space">    </span>let gazeSmooth = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* =========================================================</p>
<p class="p1"><span class="Apple-converted-space">       </span>MediaPipe FaceMesh</p>
<p class="p1"><span class="Apple-converted-space">    </span>========================================================= */</p>
<p class="p1"><span class="Apple-converted-space">    </span>const video = document.getElementById("video");</p>
<p class="p1"><span class="Apple-converted-space">    </span>const statEl = document.getElementById("stat");</p>
<p class="p1"><span class="Apple-converted-space">    </span>const startBtn = document.getElementById("startBtn");</p>
<p class="p1"><span class="Apple-converted-space">    </span>const stopBtn = document.getElementById("stopBtn");</p>
<p class="p1"><span class="Apple-converted-space">    </span>const showVideo = document.getElementById("showVideo");</p>
<p class="p1"><span class="Apple-converted-space">    </span>const photoOverlay = document.getElementById("photoOverlay");</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>showVideo.addEventListener("change", ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">      </span>video.style.display = showVideo.checked ? "block" : "none";</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>let cameraUtils = null;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let faceMesh = null;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let running = false;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Blink state</p>
<p class="p1"><span class="Apple-converted-space">    </span>let blinkFrames = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let lastBlinkTime = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let blinkCountWindow = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function applyEyeTriggers(blinkEvent, doubleBlink, gazeX){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const now = performance.now();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>if(blinkEvent){</p>
<p class="p1"><span class="Apple-converted-space">        </span>lightsBoostUntil = now + 1200;</p>
<p class="p1"><span class="Apple-converted-space">        </span>shakeUntil = now + 180;</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbPulseUntil = now + 1200;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>if(doubleBlink){</p>
<p class="p1"><span class="Apple-converted-space">        </span>photoShowUntil = now + PHOTO_SHOW_MS;</p>
<p class="p1"><span class="Apple-converted-space">        </span>lightsBoostUntil = Math.max(lightsBoostUntil, now + 1500);</p>
<p class="p1"><span class="Apple-converted-space">        </span>shakeUntil = Math.max(shakeUntil, now + 220);</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbPulseUntil = Math.max(orbPulseUntil, now + 1500);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>let gx = gazeX;</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(Math.abs(gx) &lt; GAZE_DEADZONE) gx = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>if(gx &gt;= GAZE_RIGHT_TH){</p>
<p class="p1"><span class="Apple-converted-space">        </span>cameraMode = "DOOR";</p>
<p class="p1"><span class="Apple-converted-space">        </span>cameraModeUntil = now + 700;</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if(gx &lt;= GAZE_LEFT_TH){</p>
<p class="p1"><span class="Apple-converted-space">        </span>cameraMode = "TREE";</p>
<p class="p1"><span class="Apple-converted-space">        </span>cameraModeUntil = now + 700;</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(now &gt; cameraModeUntil) cameraMode = "BASE";</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>if(now &lt; photoShowUntil) photoOverlay.classList.add("on");</p>
<p class="p1"><span class="Apple-converted-space">      </span>else photoOverlay.classList.remove("on");</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>async function startCamera(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(running) return;</p>
<p class="p1"><span class="Apple-converted-space">      </span>running = true;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>faceMesh = new FaceMesh.FaceMesh({</p>
<p class="p1"><span class="Apple-converted-space">        </span>locateFile: (file) =&gt; `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>faceMesh.setOptions({</p>
<p class="p1"><span class="Apple-converted-space">        </span>maxNumFaces: 1,</p>
<p class="p1"><span class="Apple-converted-space">        </span>refineLandmarks: true,</p>
<p class="p1"><span class="Apple-converted-space">        </span>minDetectionConfidence: 0.5,</p>
<p class="p1"><span class="Apple-converted-space">        </span>minTrackingConfidence: 0.5</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>faceMesh.onResults((results)=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!results.multiFaceLandmarks || results.multiFaceLandmarks.length===0) return;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const lm = results.multiFaceLandmarks[0];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const ear = (eyeAspectRatio(lm, LEFT_EYE_IDX) + eyeAspectRatio(lm, RIGHT_EYE_IDX)) / 2;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Blink detect</p>
<p class="p1"><span class="Apple-converted-space">        </span>let blinkEvent = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(ear &lt; EAR_BLINK_THRESHOLD){</p>
<p class="p1"><span class="Apple-converted-space">          </span>blinkFrames++;</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(blinkFrames &gt;= BLINK_MIN_FRAMES) blinkEvent = true;</p>
<p class="p1"><span class="Apple-converted-space">          </span>blinkFrames = 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Double blink</p>
<p class="p1"><span class="Apple-converted-space">        </span>let doubleBlink = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const now = performance.now();</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(blinkEvent){</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(now - lastBlinkTime &lt;= DOUBLE_BLINK_WINDOW){</p>
<p class="p1"><span class="Apple-converted-space">            </span>blinkCountWindow++;</p>
<p class="p1"><span class="Apple-converted-space">          </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>blinkCountWindow = 1;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>lastBlinkTime = now;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>if(blinkCountWindow &gt;= 2){</p>
<p class="p1"><span class="Apple-converted-space">            </span>doubleBlink = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>blinkCountWindow = 0;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const gazeX = estimateGazeX(lm);</p>
<p class="p1"><span class="Apple-converted-space">        </span>gazeSmooth = GAZE_SMOOTH*gazeSmooth + (1-GAZE_SMOOTH)*gazeX;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>applyEyeTriggers(blinkEvent, doubleBlink, gazeSmooth);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>statEl.textContent =</p>
<p class="p1"><span class="Apple-converted-space">          </span>`EAR=${ear.toFixed(3)}<span class="Apple-converted-space">  </span>GAZE_X=${gazeSmooth.toFixed(3)}<span class="Apple-converted-space">  </span>CAM=${cameraMode}<span class="Apple-converted-space">  </span>PHOTOS=${(performance.now()&lt;photoShowUntil)?"ON":"OFF"}`;</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>cameraUtils = new Camera(video, {</p>
<p class="p1"><span class="Apple-converted-space">        </span>onFrame: async () =&gt; { await faceMesh.send({ image: video }); },</p>
<p class="p1"><span class="Apple-converted-space">        </span>width: 640,</p>
<p class="p1"><span class="Apple-converted-space">        </span>height: 480</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>await cameraUtils.start();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>startBtn.disabled = true;</p>
<p class="p1"><span class="Apple-converted-space">      </span>stopBtn.disabled = false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function stopCamera(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>running = false;</p>
<p class="p1"><span class="Apple-converted-space">      </span>try { if(cameraUtils) cameraUtils.stop(); } catch(e){}</p>
<p class="p1"><span class="Apple-converted-space">      </span>cameraUtils = null;</p>
<p class="p1"><span class="Apple-converted-space">      </span>faceMesh = null;</p>
<p class="p1"><span class="Apple-converted-space">      </span>startBtn.disabled = false;</p>
<p class="p1"><span class="Apple-converted-space">      </span>stopBtn.disabled = true;</p>
<p class="p1"><span class="Apple-converted-space">      </span>statEl.textContent = "";</p>
<p class="p1"><span class="Apple-converted-space">      </span>photoOverlay.classList.remove("on");</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>startBtn.addEventListener("click", startCamera);</p>
<p class="p1"><span class="Apple-converted-space">    </span>stopBtn.addEventListener("click", stopCamera);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>/* =========================================================</p>
<p class="p1"><span class="Apple-converted-space">       </span>ANIMATION LOOP</p>
<p class="p1"><span class="Apple-converted-space">    </span>========================================================= */</p>
<p class="p1"><span class="Apple-converted-space">    </span>const clock = new THREE.Clock();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function animate(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>requestAnimationFrame(animate);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const dt = clock.getDelta();</p>
<p class="p1"><span class="Apple-converted-space">      </span>const t = clock.getElapsedTime();</p>
<p class="p1"><span class="Apple-converted-space">      </span>const now = performance.now();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Snow update</p>
<p class="p1"><span class="Apple-converted-space">      </span>const pos = snowGeo.attributes.position.array;</p>
<p class="p1"><span class="Apple-converted-space">      </span>for(let i=0;i&lt;snowCount;i++){</p>
<p class="p1"><span class="Apple-converted-space">        </span>pos[i*3+0] += snowVel[i*3+0]*dt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>pos[i*3+1] += snowVel[i*3+1]*dt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>pos[i*3+2] += snowVel[i*3+2]*dt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>if(pos[i*3+1] &lt; 0.2){</p>
<p class="p1"><span class="Apple-converted-space">          </span>pos[i*3+0] = (Math.random()*2-1)*22;</p>
<p class="p1"><span class="Apple-converted-space">          </span>pos[i*3+1] = Math.random()*14 + 8;</p>
<p class="p1"><span class="Apple-converted-space">          </span>pos[i*3+2] = (Math.random()*2-1)*18;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>snowGeo.attributes.position.needsUpdate = true;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Smoke spawn/update</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(Math.random() &lt; 0.18) spawnSmoke();</p>
<p class="p1"><span class="Apple-converted-space">      </span>for(let i=smokeGroup.children.length-1;i&gt;=0;i--){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const s = smokeGroup.children[i];</p>
<p class="p1"><span class="Apple-converted-space">        </span>const u = s.userData;</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.t += dt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>s.position.x += u.vx*dt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>s.position.y += u.vy*dt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>s.position.z += u.vz*dt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>s.scale.multiplyScalar(1 + 0.25*dt);</p>
<p class="p1"><span class="Apple-converted-space">        </span>s.material.opacity = 0.18 * (1 - (u.t/u.life));</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(u.t &gt; u.life) smokeGroup.remove(s);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Lights twinkle + boost</p>
<p class="p1"><span class="Apple-converted-space">      </span>const boost = (now &lt; lightsBoostUntil) ? 1.9 : 1.0;</p>
<p class="p1"><span class="Apple-converted-space">      </span>bulbs.children.forEach((b, i)=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">        </span>const mat = b.material;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const puls = 0.6 + 0.4*Math.sin(t*2.2 + i*0.7);</p>
<p class="p1"><span class="Apple-converted-space">        </span>mat.emissiveIntensity = (1.2 + 1.0*puls) * boost;</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Orb target logic (Guide B, no text)</p>
<p class="p1"><span class="Apple-converted-space">      </span>const orbTarget = new THREE.Vector3(3.0, 4.8, 3.0);</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(cameraMode === "DOOR"){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const p = doorAnchor.getWorldPosition(new THREE.Vector3());</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbTarget.copy(p).add(new THREE.Vector3(1.4, 2.0, 1.2));</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if(cameraMode === "TREE"){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const p = treeAnchor.getWorldPosition(new THREE.Vector3());</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbTarget.copy(p).add(new THREE.Vector3(1.2, 1.8, 1.6));</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if(now &lt; photoShowUntil){</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbTarget.set(5.5, 4.6, 5.0);</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbTarget.set(3.0 + 0.35*Math.sin(t*1.2), 4.8 + 0.25*Math.sin(t*1.7), 3.0);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Orb move (spring-ish)</p>
<p class="p1"><span class="Apple-converted-space">      </span>orb.position.lerp(orbTarget, 1 - Math.pow(0.001, dt));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Orb pulse on blink</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(now &lt; orbPulseUntil){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const p = 0.6 + 0.4*Math.sin(t*12);</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbMat.emissiveIntensity = 3.4 + 2.2*p;</p>
<p class="p1"><span class="Apple-converted-space">        </span>bloom.strength = 1.05;</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>orbMat.emissiveIntensity = 2.8;</p>
<p class="p1"><span class="Apple-converted-space">        </span>bloom.strength = 0.9;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Orb trail</p>
<p class="p1"><span class="Apple-converted-space">      </span>pushTrail(orb.position);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Camera</p>
<p class="p1"><span class="Apple-converted-space">      </span>let targetCamPos = camBasePos.clone();</p>
<p class="p1"><span class="Apple-converted-space">      </span>let targetLook = camBaseLook.clone();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>if(cameraMode === "DOOR"){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const d = getDoorCam();</p>
<p class="p1"><span class="Apple-converted-space">        </span>targetCamPos = d.camP;</p>
<p class="p1"><span class="Apple-converted-space">        </span>targetLook = d.look;</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if(cameraMode === "TREE"){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const d = getTreeCam();</p>
<p class="p1"><span class="Apple-converted-space">        </span>targetCamPos = d.camP;</p>
<p class="p1"><span class="Apple-converted-space">        </span>targetLook = d.look;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Smooth camera follow</p>
<p class="p1"><span class="Apple-converted-space">      </span>camera.position.lerp(targetCamPos, 1 - Math.pow(0.002, dt));</p>
<p class="p1"><span class="Apple-converted-space">      </span>const lookNow = new THREE.Vector3();</p>
<p class="p1"><span class="Apple-converted-space">      </span>camera.getWorldDirection(lookNow);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const currLook = camera.position.clone().add(lookNow);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const nextLook = currLook.lerp(targetLook, 1 - Math.pow(0.002, dt));</p>
<p class="p1"><span class="Apple-converted-space">      </span>camera.lookAt(nextLook);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Camera shake</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(now &lt; shakeUntil){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const amp = 0.06;</p>
<p class="p1"><span class="Apple-converted-space">        </span>camera.position.x += (Math.random()*2-1)*amp;</p>
<p class="p1"><span class="Apple-converted-space">        </span>camera.position.y += (Math.random()*2-1)*amp;</p>
<p class="p1"><span class="Apple-converted-space">        </span>camera.position.z += (Math.random()*2-1)*amp;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>composer.render();</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>animate();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>window.addEventListener("resize", ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">      </span>renderer.setSize(window.innerWidth, window.innerHeight);</p>
<p class="p1"><span class="Apple-converted-space">      </span>camera.aspect = window.innerWidth / window.innerHeight;</p>
<p class="p1"><span class="Apple-converted-space">      </span>camera.updateProjectionMatrix();</p>
<p class="p1"><span class="Apple-converted-space">      </span>composer.setSize(window.innerWidth, window.innerHeight);</p>
<p class="p1"><span class="Apple-converted-space">      </span>bloom.setSize(window.innerWidth, window.innerHeight);</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
